<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gtech Mobile</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .header-text {
            color: #a0a0a0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }

        .user-info {
            text-align: center;
            padding: 30px 20px;
        }

        .user-name {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .balance-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .balance-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 18px;
            color: #a0a0a0;
        }

        .coin-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #f39c12, #f1c40f);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .ticket-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(45deg, #e67e22, #f39c12);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .balance-value {
            color: #f39c12;
            font-weight: bold;
        }

        .main-actions {
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-btn {
            background: linear-gradient(45deg, #8b4513, #d2691e);
            border: none;
            border-radius: 20px;
            padding: 18px 30px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .gift-btn {
            background: linear-gradient(45deg, #2c3e50, #34495e);
        }

        .action-icon {
            font-size: 20px;
        }

        .grid-section {
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .grid-item {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .grid-item:first-child {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .grid-icon {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .grid-title {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            line-height: 1.3;
        }

        .bottom-actions {
            padding: 0 20px 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bottom-btn {
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 20px;
            padding: 18px 30px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .bottom-btn:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .modal-subtitle {
            color: #a0a0a0;
            font-size: 14px;
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        /* Бонусная система */
        .bonus-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .bonus-day {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .bonus-day.active {
            background: rgba(241, 196, 15, 0.2);
            border-color: #f1c40f;
        }

        .bonus-day.claimed {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        .bonus-day-number {
            font-size: 12px;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .bonus-reward {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .timer-info {
            text-align: center;
            color: #a0a0a0;
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Топ игроков */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .rank {
            font-size: 16px;
            font-weight: bold;
            color: #f39c12;
            min-width: 30px;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .player-info { flex: 1; }
        .player-name { font-weight: bold; margin-bottom: 2px; }

        .player-score {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #f39c12;
            font-size: 14px;
        }

        /* Админ панель */
        .admin-panel {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            border-radius: 20px;
            padding: 20px;
            margin: 20px;
            display: none;
        }

        .admin-panel.show { display: block; }

        .admin-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }

        .admin-stat-value { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .admin-stat-label { font-size: 12px; opacity: 0.8; }

        .admin-actions { display: flex; flex-direction: column; gap: 10px; }
        .admin-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 15px; padding: 12px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .admin-btn:hover { background: rgba(255,255,255,0.3); }

        .admin-indicator { background: linear-gradient(45deg, #e74c3c, #c0392b); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }

        /* Download buttons */
        .download-section { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .download-btn { background: rgba(255,255,255,0.1); border: none; border-radius: 20px; padding: 18px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; }
        .download-btn:hover { background: rgba(255,255,255,0.2); }
        .telegram-btn { background: linear-gradient(45deg, #0088cc, #0066cc); }
        .appgallery-btn { background: linear-gradient(45deg, #4c75a3, #2b5876); }
        .rustore-btn { background: linear-gradient(45deg, #5865F2, #404EED); }

        /* Responsive */
        @media (max-width: 400px) {
            .grid-section { grid-template-columns: 1fr; }
            .bonus-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div id="mainScreen">
        <header class="header">
            <div class="logo-section">
                <div class="logo" id="logoClick" onclick="handleLogoClick()">
                    <span style="font-size: 20px;">▲</span>
                </div>
                <div class="header-text">Система<br>Активностей</div>
            </div>
            <div class="header-actions">
                <div id="adminIndicator" style="display: none;" onclick="toggleAdminPanel()">
                    <div class="admin-indicator">👑</div>
                </div>
                <button class="header-btn">⋯</button>
                <button class="header-btn" onclick="closeApp()">✕</button>
            </div>
        </header>

        <div class="user-info">
            <div class="user-name" id="userName">ГОСТЬ</div>
            <div class="balance-section">
                <div class="balance-item">
                    <span>ВАШ БАЛАНС:</span>
                    <div class="coin-icon">₽</div>
                    <span class="balance-value" id="balance">0</span>
                </div>
                <div class="balance-item">
                    <span>БИЛЕТОВ:</span>
                    <div class="ticket-icon">🎫</div>
                    <span class="balance-value" id="tickets">0</span>
                </div>
            </div>
        </div>

        <div class="main-actions">
            <button class="action-btn" onclick="openModal('downloadModal')">
                <span class="action-icon">⬇</span>
                СКАЧАТЬ ИГРУ
            </button>
            <button class="action-btn gift-btn" onclick="openModal('bonusModal')">
                <span class="action-icon">🎁</span>
                ПОЛУЧИТЬ ПОДАРОК
            </button>
        </div>

        <div class="grid-section">
            <div class="grid-item" onclick="openModal('leaderboardModal')">
                <div class="grid-icon">📊</div>
                <div class="grid-title">ТОП АКТИВНЫХ<br>ИГРОКОВ</div>
            </div>
        </div>

        <div class="bottom-actions">
            <button class="bottom-btn" onclick="openModal('bonusModal')">
                <span class="action-icon">🎁</span>
                БОНУСНЫЕ МОНЕТЫ
            </button>
            <button class="bottom-btn" onclick="openModal('promoModal')">
                <span class="action-icon">🏷️</span>
                ВВЕСТИ ПРОМОКОД
            </button>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel">
        <div class="admin-title">👑 АДМИН ПАНЕЛЬ</div>
        <div class="admin-stats">
            <div class="admin-stat">
                <div class="admin-stat-value" id="adminUserCount">0</div>
                <div class="admin-stat-label">Всего пользователей</div>
            </div>
            <div class="admin-stat">
                <div class="admin-stat-value" id="adminActiveToday">0</div>
                <div class="admin-stat-label">Активных сегодня</div>
            </div>
            <div class="admin-stat">
                <div class="admin-stat-value" id="adminTotalBalance">0</div>
                <div class="admin-stat-label">Общий баланс</div>
            </div>
            <div class="admin-stat">
                <div class="admin-stat-value" id="adminPromosUsed">0</div>
                <div class="admin-stat-label">Использовано промокодов</div>
            </div>
            <div class="admin-stat">
                <div class="admin-stat-value" id="adminPromoCount">0</div>
                <div class="admin-stat-label">Доступно промокодов</div>
            </div>
        </div>
        <div class="admin-actions">
            <button class="admin-btn" onclick="showCreatePromo()">📝 Создать промокод</button>
            <button class="admin-btn" onclick="showUserManagement()">👥 Управление пользователями</button>
            <button class="admin-btn" onclick="showPromoManagement()">🎫 Управление промокодами</button>
            <button class="admin-btn" onclick="manageLeaderboard()">🏆 Управление лидербордом</button>
            <button class="admin-btn" onclick="showLinkManagement()">🔗 Управление ссылками</button>
            <button class="admin-btn" onclick="exportData()">📊 Экспорт данных</button>
            <button class="admin-btn" onclick="resetLeaderboard()" style="background: rgba(231, 76, 60, 0.3);">🔄 СБРОС ЛИДЕРБОРДА</button>
            <button class="admin-btn" onclick="toggleAdminPanel()" style="background: rgba(255,255,255,0.1);">❌ Закрыть панель</button>
        </div>
    </div>

    <div class="modal" id="downloadModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">КАК НАЧАТЬ ИГРАТЬ</div>
                <button class="close-btn" onclick="closeModal('downloadModal')">✕</button>
            </div>
            <div class="modal-subtitle">
                ЧТОБЫ НАЧАТЬ ИГРАТЬ НА НАШЕМ ПРОЕКТЕ - НЕОБХОДИМО СКАЧАТЬ И УСТАНОВИТЬ ЛАУНЧЕР И ЗАПУСТИТЬ ЕГО, ВСЮ ЗАГРУЗКУ И УСТАНОВКУ ИГРЫ ЛАУНЧЕР СДЕЛАЕТ САМ
            </div>
            <div class="modal-subtitle">
                СКАЧАЙ И УСТАНОВИ ЛАУНЧЕР, ДОЖДИСЬ ЗАГРУЗКИ ФАЙЛОВ И НАЧНИ ИГРАТЬ!
            </div>
            <div class="download-section">
                <button class="download-btn telegram-btn" onclick="downloadTelegram()">📱 TELEGRAM</button>
                <button class="download-btn appgallery-btn" onclick="downloadVk()">📱 VK</button>
                <button class="download-btn rustore-btn" onclick="downloadDiscord()">📱 Discord</button>
            </div>
        </div>
    </div>

    <div class="modal" id="bonusModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">БОНУСНЫЕ МОНЕТЫ</div>
                <button class="close-btn" onclick="closeModal('bonusModal')">✕</button>
            </div>
            <div class="modal-subtitle">Заходите каждый день и забирайте бонусы.</div>
            <div class="timer-info" id="bonusTimer">Можно забрать бонус через: 23ч. 59м. 48сек.</div>
            <div class="bonus-grid" id="bonusGrid"></div>
        </div>
    </div>

    <div class="modal" id="promoModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ВВЕСТИ ПРОМОКОД</div>
                <button class="close-btn" onclick="closeModal('promoModal')">✕</button>
            </div>
            <div class="modal-subtitle">Введите ваш промокод</div>
            <div class="promo-form">
                <input type="text" class="promo-input" id="promoInput" placeholder="Например, 1aA2-3bB4" style="width:100%;background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);border-radius:15px;padding:15px;color:white;font-size:16px;margin-bottom:15px;">
                <button class="promo-submit" onclick="activatePromo()" style="width:100%;background:linear-gradient(45deg,#2ecc71,#27ae60);border:none;border-radius:15px;padding:15px;color:white;font-size:16px;font-weight:bold;cursor:pointer;text-transform:uppercase;">ПРИМЕНИТЬ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="leaderboardModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ТОП АКТИВНЫХ ИГРОКОВ</div>
                <button class="close-btn" onclick="closeModal('leaderboardModal')">✕</button>
            </div>
            <div class="modal-subtitle">Все выводы товаров происходят каждый понедельник с 00:00 по 23:00</div>
            <div id="leaderboardList"></div>
        </div>
    </div>

    <script>
        let appData = {
            user: {
                id: null,
                name: 'ГОСТЬ',
                balance: 0,
                tickets: 0,
                lastBonusDate: null,
                bonusDays: 0,
                usedPromos: [],
                isAdmin: false,
                username: null
            },
            settings: {
                adminIds: [6595683709],
                downloadLinks: {
                    telegram: 'https://t.me/gtechmobile',
                    vk: 'https://vk.com',
                    discord: 'https://discord.com'
                }
            },
            users: [],
            promos: [
                { code: '1aA2-3bB4', reward: 100, uses: 0, maxUses: 10, created: new Date().toISOString() },
                { code: 'BONUS2024', reward: 250, uses: 0, maxUses: 5, created: new Date().toISOString() }
            ],
            leaderboard: [],
            adminClicks: 0,
            statistics: { totalUsers: 0, totalBalance: 0, activeToday: 0, promosUsed: 0 }
        };

        function deepMerge(target, source) {
            if (typeof target !== 'object' || target === null) return source;
            if (typeof source !== 'object' || source === null) return target;
            const result = Array.isArray(target) ? target.slice() : { ...target };
            Object.keys(source).forEach((key) => {
                const sVal = source[key];
                const tVal = result[key];
                if (Array.isArray(sVal)) {
                    result[key] = sVal.slice();
                } else if (typeof sVal === 'object' && sVal !== null) {
                    result[key] = deepMerge(typeof tVal === 'object' && tVal !== null ? tVal : {}, sVal);
                } else {
                    result[key] = sVal;
                }
            });
            return result;
        }

        function migrateSettings() {
            if (!appData.settings) appData.settings = {};
            if (!appData.settings.downloadLinks) appData.settings.downloadLinks = {};
            const links = appData.settings.downloadLinks;
            if (links.Vk && !links.vk) links.vk = links.Vk;
            if (links.Telegram && !links.telegram) links.telegram = links.Telegram;
            if (links.appgallery && !links.vk) links.vk = links.appgallery;
            if (links.rustore && !links.discord) links.discord = links.rustore;
            delete links.Vk; delete links.Telegram; delete links.appgallery; delete links.rustore;
            if (!links.telegram) links.telegram = 'https://t.me/gtechmobile';
            if (!links.vk) links.vk = 'https://vk.com';
            if (!links.discord) links.discord = 'https://discord.com';
        }

        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            const user = tg.initDataUnsafe?.user;
            if (user) {
                let rawName = (user.first_name || '').trim();
                if (user.last_name) rawName += ' ' + user.last_name;
                if (!rawName && user.username) rawName = '@' + user.username;
                appData.user.name = rawName.trim().toUpperCase();
                appData.user.id = user.id;
                appData.user.username = user.username || null;
                document.getElementById('userName').textContent = appData.user.name;
                appData.user.isAdmin = appData.settings.adminIds.includes(user.id);
                if (appData.user.isAdmin) document.getElementById('adminIndicator').style.display = 'block';
            }
        }

        function loadData() {
            const saved = localStorage.getItem('miniAppData');
            if (saved) {
                const parsed = JSON.parse(saved);
                appData = deepMerge(appData, parsed);
            }
            migrateSettings();
            updateUI();
            generateBonusCalendar();
            generateLeaderboard();
        }

        function saveData() { localStorage.setItem('miniAppData', JSON.stringify(appData)); }

        function updateUI() {
            document.getElementById('balance').textContent = appData.user.balance;
            document.getElementById('tickets').textContent = appData.user.tickets;
            document.getElementById('userName').textContent = appData.user.name;
        }

        function toggleAdminPanel() {
            if (!appData.user.isAdmin) return;
            const panel = document.getElementById('adminPanel');
            const isVisible = panel.classList.contains('show');
            if (isVisible) { panel.classList.remove('show'); panel.style.display = 'none'; }
            else { updateAdminStats(); panel.style.display = 'block'; panel.classList.add('show'); }
        }

        function updateAdminStats() {
            const today = new Date().toDateString();
            const activeToday = appData.users.filter(u => u.lastActive && new Date(u.lastActive).toDateString() === today).length;
            const totalBalance = appData.users.reduce((sum, u) => sum + (u.balance || 0), 0);
            const promosUsed = appData.promos.reduce((sum, p) => sum + p.uses, 0);
            document.getElementById('adminUserCount').textContent = appData.users.length;
            document.getElementById('adminActiveToday').textContent = activeToday;
            document.getElementById('adminTotalBalance').textContent = totalBalance;
            document.getElementById('adminPromosUsed').textContent = promosUsed;
            document.getElementById('adminPromoCount').textContent = appData.promos.length;
        }

        function showCreatePromo() {
            const promoCode = prompt('Введите код промокода (например, BONUS2024):');
            if (!promoCode) return;
            const reward = parseInt(prompt('Введите награду (количество монет):'));
            if (!reward || reward <= 0) { alert('❌ Неверная награда!'); return; }
            const maxUses = parseInt(prompt('Максимальное количество использований:'));
            if (!maxUses || maxUses <= 0) { alert('❌ Неверное количество использований!'); return; }
            if (appData.promos.find(p => p.code === promoCode)) { alert('❌ Промокод уже существует!'); return; }
            appData.promos.push({ code: promoCode, reward, uses: 0, maxUses, created: new Date().toISOString(), createdBy: appData.user.id });
            saveData(); updateAdminStats();
            if (tg) tg.showAlert(`✅ Промокод "${promoCode}" создан!\nНаграда: ${reward} монет\nИспользований: ${maxUses}`);
            else alert(`✅ Промокод "${promoCode}" создан!\nНаграда: ${reward} монет\nИспользований: ${maxUses}`);
        }

        function showUserManagement() {
            if (!appData.users.length) { alert('👥 Пользователи не найдены'); return; }
            let usersList = 'Выберите пользователя для управления:\n\n';
            appData.users.forEach((user, index) => {
                const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Никогда';
                usersList += `${index + 1}. ${user.name}\n   ID: ${user.id}\n   Баланс: ${user.balance || 0}\n   Билеты: ${user.tickets || 0}\n   Последняя активность: ${lastActive}\n\n`;
            });
            const userIndex = parseInt(prompt(usersList + 'Введите номер пользователя:')) - 1;
            if (userIndex >= 0 && userIndex < appData.users.length) manageSpecificUser(appData.users[userIndex]);
        }

        function manageSpecificUser(user) {
            const action = prompt(`Управление пользователем ${user.name}:\n\n1 - Добавить баланс\n2 - Списать баланс\n3 - Добавить билеты\n4 - Заблокировать\n5 - Удалить\n\nВведите номер действия:`);
            switch(action) {
                case '1': {
                    const addBalance = parseInt(prompt('Сколько монет добавить:'));
                    if (addBalance > 0) { user.balance = (user.balance || 0) + addBalance; saveData(); alert(`✅ Добавлено ${addBalance} монет пользователю ${user.name}`); }
                    break;
                }
                case '2': {
                    const subBalance = parseInt(prompt('Сколько монет списать:'));
                    if (subBalance > 0) { user.balance = Math.max(0, (user.balance || 0) - subBalance); saveData(); alert(`✅ Списано ${subBalance} монет у пользователя ${user.name}`); }
                    break;
                }
                case '3': {
                    const addTickets = parseInt(prompt('Сколько билетов добавить:'));
                    if (addTickets > 0) { user.tickets = (user.tickets || 0) + addTickets; saveData(); alert(`✅ Добавлено ${addTickets} билетов пользователю ${user.name}`); }
                    break;
                }
                case '4': { user.blocked = !user.blocked; saveData(); alert(`✅ Пользователь ${user.name} ${user.blocked ? 'заблокирован' : 'разблокирован'}`); break; }
                case '5': {
                    if (confirm(`Удалить пользователя ${user.name}?`)) { appData.users = appData.users.filter(u => u.id !== user.id); saveData(); alert(`✅ Пользователь ${user.name} удален`); }
                    break;
                }
            }
        }

        function showPromoManagement() {
            if (!appData.promos.length) { alert('🎫 Промокоды не найдены'); return; }
            let promosList = 'Управление промокодами:\n\n';
            appData.promos.forEach((promo, index) => {
                promosList += `${index + 1}. ${promo.code}\n   Награда: ${promo.reward}\n   Использовано: ${promo.uses}/${promo.maxUses}\n   Создан: ${new Date(promo.created).toLocaleDateString()}\n\n`;
            });
            const promoIndex = parseInt(prompt(promosList + 'Введите номер для удаления (или 0 для отмены):')) - 1;
            if (promoIndex >= 0 && promoIndex < appData.promos.length) {
                if (confirm(`Удалить промокод "${appData.promos[promoIndex].code}"?`)) { appData.promos.splice(promoIndex, 1); saveData(); alert('✅ Промокод удален'); }
            }
        }

        function showLinkManagement() {
            const platform = prompt('Какую ссылку изменить?\n\n1 - Telegram\n2 - Vk\n3 - Discord\n\nВведите номер:');
            let currentLink = ''; let linkType = '';
            switch(platform) {
                case '1': currentLink = appData.settings.downloadLinks.telegram; linkType = 'telegram'; break;
                case '2': currentLink = appData.settings.downloadLinks.vk; linkType = 'vk'; break;
                case '3': currentLink = appData.settings.downloadLinks.discord; linkType = 'discord'; break;
                default: return;
            }
            const newLink = prompt(`Текущая ссылка:\n${currentLink}\n\nВведите новую ссылку:`);
            if (newLink) { appData.settings.downloadLinks[linkType] = newLink; saveData(); alert('✅ Ссылка обновлена'); }
        }

        function exportData() {
            const data = {
                users: appData.users,
                promos: appData.promos,
                statistics: {
                    totalUsers: appData.users.length,
                    totalBalance: appData.users.reduce((sum, u) => sum + (u.balance || 0), 0),
                    activeToday: appData.users.filter(u => u.lastActive && new Date(u.lastActive).toDateString() === new Date().toDateString()).length,
                    exportDate: new Date().toISOString()
                }
            };
            const dataStr = JSON.stringify(data, null, 2);
            if (tg) tg.sendData(dataStr); else { alert('📊 Данные экспортированы в консоль браузера'); console.log('Экспорт данных:', data); }
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openLeaderboard() { openModal('leaderboardModal'); generateLeaderboard(); }
        function openShop() { const exists = document.getElementById('shopModal'); if (exists) openModal('shopModal'); }

        function openStorage() {
            if (!appData.user.inventory || appData.user.inventory.length === 0) { alert('📦 Ваше хранилище пусто\n\nПокупайте товары в магазине!'); return; }
            let storageList = '📦 ХРАНИЛИЩЕ ПРЕДМЕТОВ\n\n';
            const statusText = { pending: '⏳ Ожидает вывода', processing: '🔄 В обработке', delivered: '✅ Доставлено' };
            appData.user.inventory.forEach((item, index) => {
                const purchaseDate = new Date(item.purchaseDate).toLocaleDateString();
                storageList += `${index + 1}. ${item.item}\n   Категория: ${item.category}\n   Куплено: ${purchaseDate}\n   Статус: ${statusText[item.status] || '❓ Неизвестно'}\n\n`;
            });
            storageList += 'Все выводы товаров происходят каждый понедельник с 00:00 по 23:00\n\nPowered by Gtech Mobile';
            alert(storageList);
        }

        function generateBonusCalendar() {
            const bonusGrid = document.getElementById('bonusGrid');
            const rewards = [5, 10, 15, 15, 15, 15, 15, 15, 15];
            bonusGrid.innerHTML = '';
            for (let i = 1; i <= 9; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'bonus-day';
                if (i <= appData.user.bonusDays) dayElement.classList.add('claimed');
                else if (i === appData.user.bonusDays + 1 && canClaimBonus()) { dayElement.classList.add('active'); dayElement.onclick = () => claimBonus(i); }
                dayElement.innerHTML = `<div class="bonus-day-number">${i} ДЕНЬ</div><div class="bonus-reward"><div class="coin-icon">₽</div><span>${rewards[i-1]}</span></div>`;
                bonusGrid.appendChild(dayElement);
            }
            updateBonusTimer();
        }

        function canClaimBonus() {
            const now = new Date();
            const lastBonus = appData.user.lastBonusDate ? new Date(appData.user.lastBonusDate) : null;
            if (!lastBonus) return true;
            const hoursDiff = (now.getTime() - lastBonus.getTime()) / (1000 * 3600);
            return hoursDiff >= 24;
        }

        function claimBonus(day) {
            if (!canClaimBonus()) { showNotification('❌ Бонус ещё не доступен!', 'error'); return; }
            const rewards = [5, 10, 15, 15, 15, 15, 15, 15, 15];
            const reward = rewards[day - 1];
            appData.user.balance += reward;
            appData.user.bonusDays = Math.max(appData.user.bonusDays, day);
            appData.user.lastBonusDate = new Date().toISOString();
            if (day === 7) {
                appData.user.balance += 50;
                showNotification(`🎉 Недельный бонус!\nВы получили ${reward} + 50 (недельный бонус) = ${reward + 50} монет!`, 'success');
            } else if (day === 9) {
                appData.user.tickets += 1;
                showNotification(`🎊 Полная серия!\nВы получили ${reward} монет + 1 билет!`, 'success');
            } else {
                showNotification(`🎉 Ежедневный бонус!\nВы получили ${reward} монет!`, 'success');
            }
            saveData(); updateUI(); generateBonusCalendar(); logUserActivity(`bonus_day_${day}`);
        }

        window.addEventListener('load', () => {
            loadData();
            if (appData.user.id) {
                let user = appData.users.find(u => u.id === appData.user.id);
                if (!user) {
                    user = { id: appData.user.id, name: appData.user.name, balance: appData.user.balance, tickets: appData.user.tickets, joinDate: new Date().toISOString(), lastActive: new Date().toISOString(), bonusDays: appData.user.bonusDays, usedPromos: appData.user.usedPromos, inventory: appData.user.inventory || [], activities: [] };
                    appData.users.push(user);
                } else {
                    user.name = appData.user.name;
                    user.lastActive = new Date().toISOString();
                    user.balance = appData.user.balance;
                    user.tickets = appData.user.tickets;
                }
                saveData();
            }
            setInterval(() => { if (document.getElementById('leaderboardModal').style.display === 'flex') generateLeaderboard(); }, 30000);
        });

        function updateBonusTimer() {
            const timerElement = document.getElementById('bonusTimer');
            if (!appData.user.lastBonusDate) { timerElement.textContent = 'Бонус доступен сейчас!'; return; }
            const lastBonus = new Date(appData.user.lastBonusDate);
            const nextBonus = new Date(lastBonus.getTime() + 24 * 60 * 60 * 1000);
            const now = new Date();
            if (now >= nextBonus) { timerElement.textContent = 'Бонус доступен сейчас!'; return; }
            const timeDiff = nextBonus.getTime() - now.getTime();
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            timerElement.textContent = `Можно забрать бонус через: ${hours}ч. ${minutes}м. ${seconds}сек.`;
        }

        function generateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            let allPlayers = [...appData.leaderboard];
            appData.users.forEach(user => {
                if (user.balance > 0) {
                    allPlayers = allPlayers.filter(p => p.name.toUpperCase() !== user.name.toUpperCase());
                    allPlayers.push({ name: user.name.toUpperCase(), score: user.balance, avatar: getUserAvatar(user.name), isReal: true, id: user.id, lastActive: user.lastActive });
                }
            });
            allPlayers.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                if (a.isReal && !b.isReal) return -1;
                if (!a.isReal && b.isReal) return 1;
                return 0;
            });
            const topPlayers = allPlayers.slice(0, 50);
            topPlayers.forEach((player, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'leaderboard-item';
                if (player.id === appData.user.id) { playerElement.style.background = 'linear-gradient(45deg, rgba(241, 196, 15, 0.2), rgba(243, 156, 18, 0.2))'; playerElement.style.border = '2px solid #f1c40f'; }
                let rankStyle = '';
                if (index === 0) rankStyle = 'color: #f1c40f; font-size: 20px;';
                else if (index === 1) rankStyle = 'color: #95a5a6; font-size: 18px;';
                else if (index === 2) rankStyle = 'color: #e67e22; font-size: 16px;';
                playerElement.innerHTML = `
                    <div class="rank" style="${rankStyle}">#${index + 1}</div>
                    <div class="player-avatar">${player.avatar}</div>
                    <div class="player-info">
                        <div class="player-name">${player.name} ${player.isReal ? '<span style="color:#2ecc71;font-size:12px;">●</span>' : '<span style="color:#95a5a6;font-size:12px;">○</span>'}</div>
                        <div class="player-score"><div class="coin-icon">₽</div><span>+${player.score}</span>${player.lastActive ? `<span style="font-size:10px;color:#95a5a6;margin-left:5px;">${getTimeAgo(player.lastActive)}</span>` : ''}</div>
                    </div>
                `;
                leaderboardList.appendChild(playerElement);
            });
            const modalTitle = document.querySelector('#leaderboardModal .modal-title');
            if (modalTitle) modalTitle.textContent = `ТОП АКТИВНЫХ ИГРОКОВ (${topPlayers.length})`;
        }

        function getUserAvatar(name) {
            const avatars = ['🎮', '💎', '👔', '💀', '⚽', '🎯', '🚀', '⭐', '🔥', '💫', '🎪', '🎨', '🎭', '🏆'];
            const nameHash = name.split('').reduce((hash, char) => hash + char.charCodeAt(0), 0);
            return avatars[nameHash % avatars.length];
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            if (diffMins < 1) return 'сейчас';
            if (diffMins < 60) return `${diffMins}м`;
            if (diffHours < 24) return `${diffHours}ч`;
            if (diffDays < 7) return `${diffDays}д`;
            return 'давно';
        }

        function handleLogoClick() {
            if (appData.user.isAdmin) { toggleAdminPanel(); return; }
            appData.adminClicks++;
            if (appData.adminClicks >= 7) {
                alert('🎊 Поздравляем!\n\nВы нашли секретную пасхалку!\n\n+50 монет к балансу!');
                appData.user.balance += 50;
                appData.adminClicks = 0;
                saveData();
                updateUI();
                logUserActivity('easter_egg');
            }
        }

        function activatePromo() {
            const promoCode = document.getElementById('promoInput').value.trim().toUpperCase();
            if (!promoCode) { showNotification('❌ Введите промокод!', 'error'); return; }
            if (appData.user.usedPromos.includes(promoCode)) { showNotification('❌ Промокод уже использован!', 'error'); return; }
            const promo = appData.promos.find(p => p.code.toUpperCase() === promoCode);
            if (!promo) { showNotification('❌ Промокод не найден!', 'error'); return; }
            if (promo.uses >= promo.maxUses) { showNotification('❌ Промокод исчерпан!', 'error'); return; }
            appData.user.balance += promo.reward;
            appData.user.usedPromos.push(promoCode);
            promo.uses++;
            saveData(); updateUI(); closeModal('promoModal'); logUserActivity(`promo_${promoCode}`);
            showNotification(`🎉 Промокод активирован!\nПолучено ${promo.reward} монет!`, 'success');
            document.getElementById('promoInput').value = '';
        }

        function showNotification(message, type = 'info') {
            if (tg) {
                if (type === 'error') tg.showAlert(message);
                else tg.showPopup({ title: type === 'success' ? 'Успех!' : 'Уведомление', message, buttons: [{type: 'ok'}] });
            } else { alert(message); }
        }

        function downloadTelegram() {
            const link = appData.settings.downloadLinks.telegram;
            if (tg) tg.openLink(link); else window.open(link, '_blank');
            logUserActivity('download_telegram');
        }
        function downloadVk() {
            const link = appData.settings.downloadLinks.vk;
            if (tg) tg.openLink(link); else window.open(link, '_blank');
            logUserActivity('download_vk');
        }
        function downloadDiscord() {
            const link = appData.settings.downloadLinks.discord;
            if (tg) tg.openLink(link); else window.open(link, '_blank');
            logUserActivity('download_discord');
        }

        function logUserActivity(action) {
            if (!appData.user.id) return;
            const user = appData.users.find(u => u.id === appData.user.id);
            if (user) {
                user.lastActive = new Date().toISOString();
                if (!user.activities) user.activities = [];
                user.activities.push({ action, timestamp: new Date().toISOString() });
                if (user.activities.length > 50) user.activities = user.activities.slice(-50);
                saveData();
            }
        }

        function openCategory(category) {
            const categoryNames = { transport: 'УНИКАЛЬНЫЙ ТРАНСПОРТ', skins: 'УНИКАЛЬНЫЕ СКИНЫ', items: 'УНИКАЛЬНЫЕ ПРЕДМЕТЫ', currency: 'ВИРТУАЛЬНАЯ ВАЛЮТА' };
            alert(`🛍️ ${categoryNames[category]}\n\nВсе выводы товаров происходят каждый понедельник с 00:00 по 23:00\n\nPowered by Gtech Mobile`);
        }

        function resetLeaderboard() {
            if (!appData.user.isAdmin) { showNotification('❌ Нет доступа!', 'error'); return; }
            const confirmation = confirm('🔄 СБРОС ЛИДЕРБОРДА\n\nВы уверены, что хотите:\n\n1. Обнулить баланс всех пользователей\n2. Сбросить бонусные дни\n3. Очистить инвентари\n4. Начать топ с нуля\n\nЭТО ДЕЙСТВИЕ НЕОБРАТИМО!');
            if (!confirmation) return;
            const doubleConfirm = prompt('Для подтверждения введите "RESET":');
            if (doubleConfirm !== 'RESET') { alert('❌ Сброс отменен'); return; }
            appData.users.forEach(user => { user.balance = 0; user.tickets = 0; user.bonusDays = 0; user.lastBonusDate = null; user.usedPromos = []; user.inventory = []; user.activities = []; });
            appData.user.balance = 0; appData.user.tickets = 0; appData.user.bonusDays = 0; appData.user.lastBonusDate = null; appData.user.usedPromos = []; appData.user.inventory = [];
            appData.leaderboard = [
                { name: 'ZUZULKO', score: 787, avatar: '🎮' },
                { name: 'SUXIZSCX', score: 214, avatar: '💎' },
                { name: 'GIG0344', score: 206, avatar: '👔' },
                { name: 'OLEG ALEKSEEV', score: 153, avatar: '💀' },
                { name: 'WERT4567889', score: 132, avatar: '⚽' }
            ];
            saveData(); updateUI(); generateBonusCalendar(); generateLeaderboard(); updateAdminStats();
            showNotification('✅ Лидерборд успешно сброшен!\n\nВсе пользователи начинают с нуля.', 'success');
        }

        function manageLeaderboard() {
            if (!appData.user.isAdmin) return;
            const action = prompt('🏆 УПРАВЛЕНИЕ ЛИДЕРБОРДОМ\n\n1 - Добавить фейкового игрока\n2 - Удалить фейкового игрока\n3 - Изменить баланс игрока\n4 - Полный сброс лидерборда\n5 - Обновить в реальном времени\n\nВведите номер действия:');
            switch(action) {
                case '1': addFakePlayer(); break;
                case '2': removeFakePlayer(); break;
                case '3': editPlayerBalance(); break;
                case '4': resetLeaderboard(); break;
                case '5': generateLeaderboard(); showNotification('✅ Лидерборд обновлен', 'success'); break;
            }
        }

        function addFakePlayer() {
            const name = prompt('Введите имя игрока:'); if (!name) return;
            const score = parseInt(prompt('Введите баланс:')); if (!score || score < 0) return;
            const avatars = ['🎮', '💎', '👔', '💀', '⚽', '🎯', '🚀', '⭐', '🔥', '💫'];
            const avatar = avatars[Math.floor(Math.random() * avatars.length)];
            appData.leaderboard.push({ name: name.toUpperCase(), score, avatar, isReal: false });
            saveData(); generateLeaderboard(); showNotification(`✅ Игрок ${name} добавлен в лидерборд`, 'success');
        }

        function removeFakePlayer() {
            const fakePlayersOnly = appData.leaderboard.filter(p => !p.isReal);
            if (fakePlayersOnly.length === 0) { alert('❌ Нет фейковых игроков для удаления'); return; }
            let playersList = 'Выберите игрока для удаления:\n\n';
            fakePlayersOnly.forEach((player, index) => { playersList += `${index + 1}. ${player.name} (${player.score})\n`; });
            const playerIndex = parseInt(prompt(playersList + '\nВведите номер:')) - 1;
            if (playerIndex >= 0 && playerIndex < fakePlayersOnly.length) {
                const playerToRemove = fakePlayersOnly[playerIndex];
                appData.leaderboard = appData.leaderboard.filter(p => p !== playerToRemove);
                saveData(); generateLeaderboard(); showNotification(`✅ Игрок ${playerToRemove.name} удален`, 'success');
            }
        }

        function editPlayerBalance() {
            let allPlayers = [...appData.leaderboard];
            appData.users.forEach(user => { if (user.balance > 0) allPlayers.push({ name: user.name, score: user.balance, isReal: true, userData: user }); });
            if (allPlayers.length === 0) { alert('❌ Нет игроков в лидерборде'); return; }
            let playersList = 'Выберите игрока:\n\n';
            allPlayers.forEach((player, index) => { playersList += `${index + 1}. ${player.name} - ${player.score} ${player.isReal ? '(реальный)' : '(фейковый)'}\n`; });
            const playerIndex = parseInt(prompt(playersList + '\nВведите номер:')) - 1;
            if (playerIndex >= 0 && playerIndex < allPlayers.length) {
                const player = allPlayers[playerIndex];
                const newBalance = parseInt(prompt(`Новый баланс для ${player.name}:`));
                if (newBalance >= 0) {
                    if (player.isReal && player.userData) {
                        player.userData.balance = newBalance;
                        if (player.userData.id === appData.user.id) { appData.user.balance = newBalance; updateUI(); }
                    } else {
                        const fakePlayer = appData.leaderboard.find(p => p.name === player.name);
                        if (fakePlayer) fakePlayer.score = newBalance;
                    }
                    saveData(); generateLeaderboard(); showNotification(`✅ Баланс игрока ${player.name} изменен на ${newBalance}`, 'success');
                }
            }
        }

        function closeApp() { if (tg) tg.close(); }

        setInterval(updateBonusTimer, 1000);

        window.addEventListener('beforeunload', () => {
            if (appData.user.id) {
                const user = appData.users.find(u => u.id === appData.user.id);
                if (user) {
                    user.balance = appData.user.balance;
                    user.tickets = appData.user.tickets;
                    user.bonusDays = appData.user.bonusDays;
                    user.usedPromos = appData.user.usedPromos;
                    user.inventory = appData.user.inventory;
                    user.lastActive = new Date().toISOString();
                }
            }
            saveData();
        });

        setInterval(() => {
            if (appData.user.id) {
                const user = appData.users.find(u => u.id === appData.user.id);
                if (user) {
                    user.balance = appData.user.balance;
                    user.tickets = appData.user.tickets;
                    user.bonusDays = appData.user.bonusDays;
                    user.usedPromos = appData.user.usedPromos;
                    user.inventory = appData.user.inventory;
                    user.lastActive = new Date().toISOString();
                }
                saveData();
            }
        }, 30000);

        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; });
        document.querySelectorAll('.modal-content').forEach(content => { content.addEventListener('click', (e) => e.stopPropagation()); });
    </script>
</body>
</html>
