    <script>
        (function() {
            const API_USERS_URL = 'api/users.php';

            async function apiUpsertCurrentUser(source) {
                try {
                    if (!window.appData || !appData.user || !appData.user.id) return;
                    const payload = {
                        action: 'upsert',
                        id: appData.user.id,
                        name: appData.user.name,
                        username: appData.user.username || null,
                        source: source || (window.Telegram?.WebApp ? 'telegram' : 'web')
                    };
                    await fetch(API_USERS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                } catch (_) {}
            }

            async function apiGetLeaderboard(params) {
                try {
                    const p = new URLSearchParams({ action: 'leaderboard', include_zero: '1', limit: String((params && params.limit) || 50) });
                    const res = await fetch(`${API_USERS_URL}?${p.toString()}`, { method: 'GET' });
                    if (!res.ok) return [];
                    const json = await res.json();
                    if (json && json.ok && Array.isArray(json.data)) return json.data;
                    return [];
                } catch (_) { return []; }
            }

            async function apiFetchUsersList(limit, offset) {
                try {
                    const p = new URLSearchParams({ action: 'list', limit: String(limit || 1000), offset: String(offset || 0) });
                    const res = await fetch(`${API_USERS_URL}?${p.toString()}`, { method: 'GET' });
                    if (!res.ok) return [];
                    const json = await res.json();
                    if (json && json.ok && Array.isArray(json.data)) return json.data;
                    return [];
                } catch (_) { return []; }
            }

            async function apiUpdateUser(update) {
                try {
                    const payload = Object.assign({ action: 'update' }, update || {});
                    const res = await fetch(API_USERS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!res.ok) return null;
                    const json = await res.json();
                    if (json && json.ok) return json.data || null;
                    return null;
                } catch (_) { return null; }
            }

            async function apiLogActivity(action) {
                try {
                    if (!appData.user || !appData.user.id) return;
                    const payload = { action: 'activity', id: appData.user.id, activity: action };
                    await fetch(API_USERS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                } catch (_) {}
            }

            function ensureWebUserId() {
                if (appData.user && appData.user.id) return;
                let storedId = localStorage.getItem('webUserId');
                if (!storedId) {
                    storedId = 'web_' + Date.now() + '_' + Math.floor(Math.random() * 1000000000);
                    localStorage.setItem('webUserId', storedId);
                }
                appData.user.id = storedId;
                appData.user.name = (appData.user.name || '–ì–û–°–¢–¨').toUpperCase();
                const el = document.getElementById('userName');
                if (el) el.textContent = appData.user.name;
            }

            async function migrateLocalUsersToDb() {
                try {
                    if (!Array.isArray(appData.users)) return;
                    for (const u of appData.users) {
                        if (!u || !u.id || !u.name) continue;
                        const payload = { action: 'upsert', id: u.id, name: String(u.name), username: null, source: 'web' };
                        await fetch(API_USERS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    }
                } catch (_) {}
            }

            window.addEventListener('load', async () => {
                try {
                    if (!window.Telegram?.WebApp) ensureWebUserId();
                    await apiUpsertCurrentUser();
                    await migrateLocalUsersToDb();
                } catch (_) {}
                setInterval(() => {
                    const modal = document.getElementById('leaderboardModal');
                    if (modal && modal.style.display === 'flex') {
                        if (typeof window.generateLeaderboard === 'function') window.generateLeaderboard();
                    }
                }, 1000);
            });

            window.generateLeaderboard = async function() {
                const leaderboardList = document.getElementById('leaderboardList');
                if (!leaderboardList) return;
                leaderboardList.innerHTML = '';
                const rows = await apiGetLeaderboard({ includeZero: true, limit: 50 });
                const topPlayers = rows.map(r => ({
                    id: r.id,
                    name: String(r.name || '').toUpperCase(),
                    score: Number(r.balance || 0),
                    lastActive: r.last_active || null,
                    isReal: true,
                    avatar: (function getUserAvatar(name) {
                        const avatars = ['üéÆ','üíé','üëî','üíÄ','‚öΩ','üéØ','üöÄ','‚≠ê','üî•','üí´','üé™','üé®','üé≠','üé™','üèÜ'];
                        const nameHash = String(name).split('').reduce((h, c) => h + c.charCodeAt(0), 0);
                        return avatars[nameHash % avatars.length];
                    })(String(r.name || ''))
                }));
                topPlayers.forEach((player, index) => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'leaderboard-item';
                    if (player.id === appData.user.id) {
                        playerElement.style.background = 'linear-gradient(45deg, rgba(241, 196, 15, 0.2), rgba(243, 156, 18, 0.2))';
                        playerElement.style.border = '2px solid #f1c40f';
                    }
                    let rankStyle = '';
                    if (index === 0) rankStyle = 'color: #f1c40f; font-size: 20px;';
                    else if (index === 1) rankStyle = 'color: #95a5a6; font-size: 18px;';
                    else if (index === 2) rankStyle = 'color: #e67e22; font-size: 16px;';
                    playerElement.innerHTML = `
                        <div class="rank" style="${rankStyle}">#${index + 1}</div>
                        <div class="player-avatar">${player.avatar}</div>
                        <div class="player-info">
                            <div class="player-name">
                                ${player.name}
                                <span style="color: #2ecc71; font-size: 12px;">‚óè</span>
                            </div>
                            <div class="player-score">
                                <div class="coin-icon">‚ÇΩ</div>
                                <span>+${player.score}</span>
                                ${player.lastActive ? `<span style="font-size: 10px; color: #95a5a6; margin-left: 5px;">${(function timeAgo(ds){const now=new Date();const d=new Date(ds);const ms=now-d;const m=Math.floor(ms/60000);const h=Math.floor(ms/3600000);const dd=Math.floor(ms/86400000);if(m<1)return '—Å–µ–π—á–∞—Å';if(m<60)return `${m}–º`;if(h<24)return `${h}—á`;if(dd<7)return `${dd}–¥`;return '–¥–∞–≤–Ω–æ';})(player.lastActive)}</span>` : ''}
                            </div>
                        </div>
                    `;
                    leaderboardList.appendChild(playerElement);
                });
                const modalTitle = document.querySelector('#leaderboardModal .modal-title');
                if (modalTitle) modalTitle.textContent = `–¢–û–ü –ê–ö–¢–ò–í–ù–´–• –ò–ì–†–û–ö–û–í (${topPlayers.length})`;
            };

            window.showUserManagement = async function() {
                const users = await apiFetchUsersList(1000, 0);
                if (!users || users.length === 0) { alert('üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'); return; }
                let usersList = '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:\n\n';
                users.forEach((u, i) => {
                    const lastActive = u.last_active ? new Date(u.last_active).toLocaleDateString() : '–ù–∏–∫–æ–≥–¥–∞';
                    usersList += `${i + 1}. ${u.name}\n   ID: ${u.id}\n   –ë–∞–ª–∞–Ω—Å: ${u.balance || 0}\n   –ë–∏–ª–µ—Ç—ã: ${u.tickets || 0}\n   –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${lastActive}\n\n`;
                });
                const idx = parseInt(prompt(usersList + '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:')) - 1;
                if (idx >= 0 && idx < users.length) window.manageSpecificUser(users[idx]);
            };

            window.manageSpecificUser = async function(user) {
                const action = prompt(`–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${user.name}:\n\n1 - –î–æ–±–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å\n2 - –°–ø–∏—Å–∞—Ç—å –±–∞–ª–∞–Ω—Å\n3 - –î–æ–±–∞–≤–∏—Ç—å –±–∏–ª–µ—Ç—ã\n4 - –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É\n0 - –û—Ç–º–µ–Ω–∞`);
                if (!action || action === '0') return;
                if (action === '1') {
                    const addBalance = parseInt(prompt('–°–∫–æ–ª—å–∫–æ –º–æ–Ω–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å:'));
                    if (addBalance > 0) {
                        const updated = await apiUpdateUser({ id: user.id, balance_delta: addBalance });
                        if (updated && appData.user.id === user.id) { appData.user.balance = updated.balance; if (typeof updateUI === 'function') updateUI(); }
                        alert(updated ? `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addBalance} –º–æ–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${user.name}` : '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                    }
                } else if (action === '2') {
                    const subBalance = parseInt(prompt('–°–∫–æ–ª—å–∫–æ –º–æ–Ω–µ—Ç —Å–ø–∏—Å–∞—Ç—å:'));
                    if (subBalance > 0) {
                        const updated = await apiUpdateUser({ id: user.id, balance_delta: -subBalance });
                        if (updated && appData.user.id === user.id) { appData.user.balance = updated.balance; if (typeof updateUI === 'function') updateUI(); }
                        alert(updated ? `‚úÖ –°–ø–∏—Å–∞–Ω–æ ${subBalance} –º–æ–Ω–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.name}` : '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                    }
                } else if (action === '3') {
                    const addTickets = parseInt(prompt('–°–∫–æ–ª—å–∫–æ –±–∏–ª–µ—Ç–æ–≤ –¥–æ–±–∞–≤–∏—Ç—å:'));
                    if (addTickets > 0) {
                        const updated = await apiUpdateUser({ id: user.id, tickets_delta: addTickets });
                        if (updated && appData.user.id === user.id) { appData.user.tickets = updated.tickets; if (typeof updateUI === 'function') updateUI(); }
                        alert(updated ? `‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${addTickets} –±–∏–ª–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${user.name}` : '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                    }
                } else if (action === '4') {
                    const updated = await apiUpdateUser({ id: user.id, blocked: user.blocked ? 0 : 1 });
                    alert(updated ? `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name} ${updated.blocked ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}` : '‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            };

            const origHandleLogoClick = window.handleLogoClick;
            window.handleLogoClick = async function() {
                if (appData.user && !appData.user.isAdmin) {
                    appData.adminClicks = (appData.adminClicks || 0) + 1;
                    if (appData.adminClicks >= 7) {
                        appData.user.balance += 50;
                        await apiUpdateUser({ id: appData.user.id, balance_delta: 50 });
                        appData.adminClicks = 0;
                    }
                }
                if (typeof origHandleLogoClick === 'function') origHandleLogoClick();
            };

            const origActivatePromo = window.activatePromo;
            window.activatePromo = async function() {
                const before = appData.user.balance;
                if (typeof origActivatePromo === 'function') origActivatePromo();
                const delta = appData.user.balance - before;
                if (delta > 0) await apiUpdateUser({ id: appData.user.id, balance_delta: delta });
            };

            const origPerformExchange = window.performExchange;
            window.performExchange = async function() {
                const beforeB = appData.user.balance;
                const beforeT = appData.user.tickets;
                if (typeof origPerformExchange === 'function') origPerformExchange();
                if (appData.user.balance !== beforeB || appData.user.tickets !== beforeT) {
                    await apiUpdateUser({ id: appData.user.id, balance_set: appData.user.balance, tickets_set: appData.user.tickets });
                }
            };

            const origShowWithdrawRequests = window.showWithdrawRequests;
            window.showWithdrawRequests = async function() {
                const prevWithdrawals = JSON.stringify(appData.withdrawals || []);
                if (typeof origShowWithdrawRequests === 'function') await origShowWithdrawRequests();
                try {
                    const after = JSON.stringify(appData.withdrawals || []);
                    if (prevWithdrawals !== after && Array.isArray(appData.users)) {
                        const current = appData.users.find(u => u.id === appData.user.id);
                        if (current) await apiUpdateUser({ id: current.id, tickets_set: current.tickets || 0 });
                    }
                } catch (_) {}
            };

            const origLogUserActivity = window.logUserActivity;
            window.logUserActivity = async function(action) {
                try { if (typeof origLogUserActivity === 'function') origLogUserActivity(action); } catch (_) {}
                await apiLogActivity(action);
            };

            const origResetLeaderboard = window.resetLeaderboard;
            window.resetLeaderboard = async function() {
                if (!appData.user || !appData.user.isAdmin) { alert('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞!'); return; }
                const ok = confirm('üîÑ –°–ë–†–û–° –õ–ò–î–ï–†–ë–û–†–î–ê\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?');
                if (!ok) return;
                const doubleConfirm = prompt('–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ "RESET":');
                if (doubleConfirm !== 'RESET') { alert('‚ùå –°–±—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω'); return; }
                try { await fetch(API_USERS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'reset' }) }); } catch (_) {}
                if (typeof origResetLeaderboard === 'function') origResetLeaderboard();
                if (typeof generateLeaderboard === 'function') generateLeaderboard();
            };
        })();
    </script>
</body>